<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group System Betting Calculator v2.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="version.js"></script>
    <style>
        /* Additional styles for group system types */
        .group-system-types {
            margin-top: 1rem;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #10b981 0%, #065f46 100%);
            min-height: 100vh;
        }
        
        /* Custom toggle switch styles - FORCE OVERRIDE */
        .toggle-switch .slider {
            background-color: #ef4444 !important; /* red-500 for LOSS */
            border: 2px solid #dc2626 !important; /* red-600 border */
        }
        .toggle-switch input:checked + .slider {
            background-color: #10b981 !important; /* emerald-500 for WIN */
            border: 2px solid #059669 !important; /* emerald-600 border */
        }
        .toggle-switch input:checked + .slider::before {
            transform: translateX(1.5rem) !important;
        }
        .toggle-switch .slider::before {
            background-color: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
        }
        
        /* WIN/LOSS label styles - FORCE COLORS */
        .text-green-600, span.text-green-600 {
            color: #059669 !important;
            font-weight: 700 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
        }
        .text-red-600, span.text-red-600 {
            color: #dc2626 !important;
            font-weight: 700 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
        }
        
        /* Make sure button colors work */
        .bg-green-500 {
            background-color: #10b981 !important;
        }
        .bg-emerald-500 {
            background-color: #10b981 !important;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex justify-center items-start min-h-screen">

    <div class="w-full max-w-6xl bg-white rounded-xl shadow-2xl p-6 md:p-10">
        <div class="flex justify-between items-center mb-6 border-b pb-3">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800">
                    Group System Betting Calculator
                </h1>
                <p class="text-sm text-gray-500 mt-1" data-app-version>Version ...</p>
            </div>
            <div class="flex gap-3">
                <button onclick="calculateProfit()" 
                        class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition">
                    üîÑ Recalculate
                </button>
                <a href="index.html" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition">
                    ‚Üê Back to Hub
                </a>
            </div>
        </div>

        <!-- Configuration Section -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="group-system-types md:col-span-2">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Group System Types</h3>
                    <p class="text-xs text-gray-500 mb-3">Pick which group folds to bet (e.g. Doubles, Trebles). Select one or more.</p>
                    <div id="group_system_types" class="flex flex-wrap gap-3"></div>
                </div>
                <div>
                    <label for="num_groups" class="block text-sm font-medium text-gray-700 mb-2">Number of Groups</label>
                    <select id="num_groups" onchange="updateConfiguration()" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="2">2 Groups</option>
                        <option value="3" selected>3 Groups</option>
                        <option value="4">4 Groups</option>
                    </select>
                </div>
                <div>
                    <label for="unit_stake" class="block text-sm font-medium text-gray-700 mb-2">Unit Stake ($)</label>
                    <input type="number" id="unit_stake" value="1.00" min="0.01" step="0.01" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg" oninput="calculateProfit()">
                </div>
            </div>
        </div>

        <!-- Default Odds Section -->
        <div class="mb-8 bg-emerald-50 p-4 rounded-lg border border-emerald-200">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">Quick Setup</h2>
            <div class="flex gap-4 items-end">
                <div class="flex-1">
                    <label for="default_odds_group" class="block text-sm font-medium text-gray-700 mb-1">Default Odds (Copy to All Teams)</label>
                    <input type="number" id="default_odds_group" value="1.50" min="1.01" step="0.01"
                           class="w-full px-3 py-2 border border-emerald-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                           placeholder="e.g., 2.00">
                </div>
                <button onclick="copyDefaultOddsToAll()" 
                        class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-lg transition">
                    Copy to All Teams
                </button>
            </div>
            <p class="text-xs text-emerald-600 mt-2">Enter odds here and click the button to set the same odds for all teams across all groups.</p>
        </div>

        <!-- Groups Section -->
        <div id="groups_container" class="mb-8">
            <!-- Groups will be populated by JavaScript -->
        </div>

        <!-- Results Section -->
        <div class="bg-green-50 border border-green-200 rounded-xl p-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Results</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="total_bets">0</div>
                    <div class="text-sm text-gray-600">Total Bets</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="total_stake">$0.00</div>
                    <div class="text-sm text-gray-600">Total Stake</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="total_returns">$0.00</div>
                    <div class="text-sm text-gray-600">Total Returns</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold" id="net_profit">$0.00</div>
                    <div class="text-sm text-gray-600">Net Profit</div>
                </div>
            </div>
            
            <div id="breakdown" class="mt-4 p-4 bg-white rounded-lg border">
                <h3 class="font-semibold text-gray-700 mb-2">Calculation Breakdown</h3>
                <div id="breakdown_content" class="text-sm text-gray-600">
                    Configure your groups to see detailed calculations
                </div>
            </div>
        </div>
    </div>

    <script>
    let numGroups = 3;
    let groupsData = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateConfiguration();
        });

        function updateConfiguration() {
            numGroups = parseInt(document.getElementById('num_groups').value);
            buildGroupSystemTypeOptions();
            
            // Initialize groups data
            groupsData = [];
            for (let i = 0; i < numGroups; i++) {
                groupsData.push({
                    teams: 3,
                    allowedSizes: [2],
                    odds: [1.5, 1.5, 1.5],
                    wins: [true, true, true]
                });
            }
            
            generateGroupsUI();
        }

        function buildGroupSystemTypeOptions() {
            const container = document.getElementById('group_system_types');
            if (!container) return; // safety
            container.innerHTML = '';
            // Only show if 2 or more groups
            if (numGroups < 2) return;
            for (let size = 2; size <= numGroups; size++) {
                const labelMap = {2: 'Doubles', 3: 'Trebles'};
                const name = labelMap[size] || `${size}-Folds`;
                const id = `group_size_${size}`;
                const wrapper = document.createElement('label');
                wrapper.className = 'flex items-center gap-2 bg-gray-100 px-3 py-1 rounded text-xs cursor-pointer hover:bg-gray-200';
                wrapper.innerHTML = `<input id="${id}" type="checkbox" class="group-size-checkbox" value="${size}" onchange="calculateProfit()"> <span>${name}</span>`;
                // default: select doubles only
                if (size === 2) wrapper.querySelector('input').checked = true;
                container.appendChild(wrapper);
            }
        }

        function generateGroupsUI() {
            const container = document.getElementById('groups_container');
            container.innerHTML = '';
            
            for (let i = 0; i < numGroups; i++) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg';
                
                groupDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Group ${String.fromCharCode(65 + i)}</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Teams in Group</label>
                            <select id="group_${i}_teams" onchange="updateGroupTeams(${i})" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="2">2 Teams</option>
                                <option value="3" selected>3 Teams</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Winning Sizes Included</label>
                            <div id="group_${i}_sizes" class="flex flex-wrap gap-2"></div>
                            <p class="mt-1 text-[10px] text-gray-500">Select one or more sizes (e.g. 2 & 3) to include.</p>
                        </div>
                    </div>
                    
                    <div id="group_${i}_teams_container" class="space-y-3">
                        <!-- Team inputs will be added here -->
                    </div>
                `;
                
                container.appendChild(groupDiv);
                updateGroupTeams(i);
            }
            
            calculateProfit();
        }

        function updateGroupTeams(groupIndex) {
            const teams = parseInt(document.getElementById(`group_${groupIndex}_teams`).value);
            const container = document.getElementById(`group_${groupIndex}_teams_container`);
            groupsData[groupIndex].teams = teams;
            groupsData[groupIndex].odds = Array(teams).fill(1.5);
            groupsData[groupIndex].wins = Array(teams).fill(true);
            groupsData[groupIndex].allowedSizes = [Math.min(2, teams)];
            buildGroupSizeCheckboxes(groupIndex);
            
            // Generate team inputs
            container.innerHTML = '';
            for (let i = 0; i < teams; i++) {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'grid grid-cols-3 gap-4 items-center';
                teamDiv.innerHTML = `
                    <span class="font-medium text-gray-700">Team ${i + 1}</span>
                    <input type="number" id="group_${groupIndex}_odds_${i}" value="1.50" min="1.01" step="0.01" 
                           oninput="updateOdds(${groupIndex}, ${i})" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <div class="flex justify-center items-center gap-2">
                        <span id="group_${groupIndex}_label_${i}" class="text-xs font-medium text-green-600">WIN</span>
                        <label class="toggle-switch relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="group_${groupIndex}_win_${i}" checked onchange="updateGroupToggleLabel(${groupIndex}, ${i}); updateWin(${groupIndex}, ${i})" class="sr-only">
                            <span class="slider w-10 h-6 rounded-full transition-colors duration-300 ease-in-out relative before:content-[''] before:absolute before:top-0.5 before:left-0.5 before:bg-white before:w-5 before:h-5 before:rounded-full before:transition-transform before:duration-300"></span>
                        </label>
                    </div>
                `;
                container.appendChild(teamDiv);
            }
            
            calculateProfit();
        }

        // Removed updateGroupRequired (multi-size selection instead)

        function buildGroupSizeCheckboxes(groupIndex) {
            const wrap = document.getElementById(`group_${groupIndex}_sizes`);
            if (!wrap) return;
            wrap.innerHTML = '';
            const teams = groupsData[groupIndex].teams;
            for (let size = 1; size <= teams; size++) {
                const id = `group_${groupIndex}_size_${size}`;
                const label = document.createElement('label');
                label.className = 'flex items-center gap-1 bg-gray-100 px-2 py-1 rounded text-[11px] cursor-pointer hover:bg-gray-200';
                const checked = groupsData[groupIndex].allowedSizes.includes(size) ? 'checked' : '';
                label.innerHTML = `<input type="checkbox" id="${id}" value="${size}" ${checked} onchange="updateGroupAllowedSizes(${groupIndex})"> <span>${size}</span>`;
                wrap.appendChild(label);
            }
        }

        function updateGroupAllowedSizes(groupIndex) {
            const teams = groupsData[groupIndex].teams;
            const selected = [];
            for (let size = 1; size <= teams; size++) {
                const cb = document.getElementById(`group_${groupIndex}_size_${size}`);
                if (cb && cb.checked) selected.push(size);
            }
            if (!selected.length) {
                selected.push(1);
                const cb1 = document.getElementById(`group_${groupIndex}_size_1`);
                if (cb1) cb1.checked = true;
            }
            groupsData[groupIndex].allowedSizes = selected;
            calculateProfit();
        }

        function updateOdds(groupIndex, teamIndex) {
            const odds = parseFloat(document.getElementById(`group_${groupIndex}_odds_${teamIndex}`).value) || 1.5;
            groupsData[groupIndex].odds[teamIndex] = odds;
            calculateProfit();
        }

        function updateWin(groupIndex, teamIndex) {
            groupsData[groupIndex].wins[teamIndex] = document.getElementById(`group_${groupIndex}_win_${teamIndex}`).checked;
            calculateProfit();
        }

        // Function to update group toggle label text and color
        function updateGroupToggleLabel(groupIndex, teamIndex) {
            const checkbox = document.getElementById(`group_${groupIndex}_win_${teamIndex}`);
            const label = document.getElementById(`group_${groupIndex}_label_${teamIndex}`);
            
            if (checkbox.checked) {
                label.textContent = 'WIN';
                label.className = 'text-xs font-medium text-green-600';
            } else {
                label.textContent = 'LOSS';
                label.className = 'text-xs font-medium text-red-600';
            }
        }

        // Combination calculation helper
        function nCr(n, r) {
            if (r > n || r < 0) return 0;
            if (r === 0 || r === n) return 1;
            let result = 1;
            for (let i = 0; i < r; i++) {
                result *= (n - i) / (i + 1);
            }
            return Math.round(result);
        }

        // Generate all combinations of given size from array
        function getCombinations(arr, size) {
            if (size === 1) return arr.map(x => [x]);
            if (size === arr.length) return [arr];
            
            const combinations = [];
            for (let i = 0; i <= arr.length - size; i++) {
                const smallerCombinations = getCombinations(arr.slice(i + 1), size - 1);
                smallerCombinations.forEach(combo => {
                    combinations.push([arr[i], ...combo]);
                });
            }
            return combinations;
        }

        function calculateProfit() {
            const stake = parseFloat(document.getElementById('unit_stake').value) || 0;
            const selectedGroupSizeElems = Array.from(document.querySelectorAll('.group-size-checkbox:checked'));
            const selectedGroupSizes = selectedGroupSizeElems.map(el => parseInt(el.value)).sort((a,b)=>a-b);

            // Removed old baseTotalBets tied to single 'required'

            // Reset if no stake
            if (stake <= 0) {
                ['total_bets','total_stake','total_returns','net_profit'].forEach(id => {
                    document.getElementById(id).textContent = id.includes('bets') ? '0' : '$0.00';
                });
                document.getElementById('breakdown_content').textContent = 'Enter a stake to calculate profits';
                return;
            }

            // Build per-group stats
            const groupStats = groupsData.map((group, gi) => {
                const winnersIdx = group.wins.map((w,i)=>w?i:null).filter(v=>v!==null);
                let combosCount = 0;
                let sumProducts = 0;
                let any = false;
                group.allowedSizes.forEach(sz => {
                    if (sz <= winnersIdx.length) {
                        any = true;
                        const combos = getCombinations(winnersIdx, sz);
                        combosCount += combos.length;
                        combos.forEach(c => {
                            let prod = 1; c.forEach(idx => prod *= group.odds[idx]);
                            sumProducts += prod;
                        });
                    }
                });
                if (!any) return { index: gi, status: 'FAIL', winnersCount: winnersIdx.length, allowed: group.allowedSizes.slice(), combosCount:0, sumProducts:0, label: `Group ${String.fromCharCode(65+gi)}` };
                return { index: gi, status: 'OK', winnersCount: winnersIdx.length, allowed: group.allowedSizes.slice(), combosCount, sumProducts, label: `Group ${String.fromCharCode(65+gi)}` };
            });

            // Require at least one system type selection
            if (!selectedGroupSizes.length) {
                document.getElementById('total_bets').textContent = '0';
                document.getElementById('total_stake').textContent = '$0.00';
                document.getElementById('total_returns').textContent = '$0.00';
                document.getElementById('net_profit').textContent = '$0.00';
                document.getElementById('breakdown_content').textContent = 'Select at least one fold type (e.g. Doubles) to calculate.';
                return;
            }

            const successful = groupStats.filter(g => g.status==='OK');
            const mode = 'system';

            // Compute base total bets for system: sum over each selected group size of all folds * product of required-size combination counts
            let totalBetsPlaced = 0;
            const perGroupRequiredCombos = groupsData.map(g => g.allowedSizes.reduce((sum, sz)=> sum + (sz<=g.teams? nCr(g.teams, sz):0), 0));
            selectedGroupSizes.forEach(size => {
                if (numGroups < size) return;
                const groupIndexArr = Array.from({length:numGroups}, (_,i)=>i);
                const folds = getCombinations(groupIndexArr, size);
                folds.forEach(fold => {
                    let foldTickets = 1;
                    fold.forEach(gIdx => { foldTickets *= perGroupRequiredCombos[gIdx]; });
                    totalBetsPlaced += foldTickets;
                });
            });

            let totalReturns = 0;
            let winningBets = 0;
            let breakdownLines = [];

            // System: only folds built from successful groups pay
            const successIndices = successful.map(g => g.index);
            selectedGroupSizes.forEach(size => {
                if (successIndices.length < size) {
                    breakdownLines.push(`${size}-Fold: not enough successful groups (${successIndices.length}/${size})`);
                    return;
                }
                const foldGroupCombos = getCombinations(successIndices, size);
                let foldWinningBets = 0;
                let foldReturnAccumulator = 0;
                foldGroupCombos.forEach(fold => {
                    // Tickets for this fold that win = product of winning combos across allowed sizes per group
                    let ticketsForFold = 1;
                    let foldReturnFactor = 1; // product of sumProducts for groups in fold
                    fold.forEach(gIdx => {
                        const gs = groupStats[gIdx];
                        ticketsForFold *= gs.combosCount; // required-size winning combos
                        foldReturnFactor *= gs.sumProducts; // sum of products of odds for those combos
                    });
                    foldWinningBets += ticketsForFold;
                    foldReturnAccumulator += foldReturnFactor;
                });
                const foldReturnMoney = foldReturnAccumulator * stake;
                totalReturns += foldReturnMoney;
                winningBets += foldWinningBets;
                const label = size===2?'Doubles':(size===3?'Trebles':`${size}-Folds`);
                breakdownLines.push(`${label}: Fold Combos ${foldGroupCombos.length} Winning Bets ${foldWinningBets.toLocaleString()} Return $${foldReturnMoney.toFixed(2)}`);
            });

            const totalStake = stake * totalBetsPlaced;
            const netProfit = totalReturns - totalStake;

            // Update UI
            document.getElementById('total_bets').textContent = totalBetsPlaced.toLocaleString();
            document.getElementById('total_stake').textContent = `$${totalStake.toFixed(2)}`;
            document.getElementById('total_returns').textContent = `$${totalReturns.toFixed(2)}`;
            const profitEl = document.getElementById('net_profit');
            profitEl.textContent = `$${netProfit.toFixed(2)}`;
            profitEl.className = netProfit >= 0 ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';

            // Breakdown
            let breakdown = '';
            breakdown += `Mode: System Types\n`;
            breakdown += `Selected Group Sizes: ${selectedGroupSizes.join(', ')}\n`;
            breakdown += `Successful Groups: ${successful.length}/${numGroups}\n`;
            breakdown += `Total Bets Placed: ${totalBetsPlaced.toLocaleString()}  Stake: $${totalStake.toFixed(2)}\n`;
            breakdown += `Winning Bets: ${winningBets.toLocaleString()}  Losing Bets: ${(totalBetsPlaced - winningBets).toLocaleString()}\n`;
            const roi = totalStake > 0 ? ((totalReturns - totalStake) / totalStake * 100) : 0;
            breakdown += `ROI: ${roi.toFixed(2)}%  Avg Return / Winning Bet: ${winningBets>0 ? '$'+(totalReturns/winningBets).toFixed(2) : '$0.00'}\n`;
            breakdown += `Returns: $${totalReturns.toFixed(2)}  Net: $${netProfit.toFixed(2)}\n\n`;
            breakdown += `Per Group (allowed sizes -> winning combos):\n`;
            groupStats.forEach(g => {
                breakdown += `${g.label} ${g.status} winners:${g.winnersCount} sizes:[${(g.allowed||[]).join(',')}] combos:${g.combosCount} factor:${g.sumProducts.toFixed(2)} return:$${(g.sumProducts*stake).toFixed(2)}\n`;
            });
            breakdown += `\nSystem Detail:\n` + breakdownLines.join('\n');
            document.getElementById('breakdown_content').textContent = breakdown;
        }

        // Function to copy default odds to all teams across all groups
        function copyDefaultOddsToAll() {
            const defaultOdds = document.getElementById('default_odds_group').value;
            if (!defaultOdds || defaultOdds < 1.01) {
                alert('Please enter valid odds (1.01 or greater)');
                return;
            }
            
            let copiedCount = 0;
            
            // Copy to all teams across all groups using the correct ID format
            for (let groupIndex = 0; groupIndex < numGroups; groupIndex++) {
                const groupTeams = groupsData[groupIndex].teams;
                for (let teamIndex = 0; teamIndex < groupTeams; teamIndex++) {
                    const oddsInput = document.getElementById(`group_${groupIndex}_odds_${teamIndex}`);
                    if (oddsInput) {
                        oddsInput.value = defaultOdds;
                        // Update the data array as well
                        groupsData[groupIndex].odds[teamIndex] = parseFloat(defaultOdds);
                        copiedCount++;
                    }
                }
            }
            
            // Recalculate after copying
            calculateProfit();
            
            // Show confirmation
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = `‚úì Copied to ${copiedCount} teams!`;
            button.classList.add('bg-emerald-600');
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('bg-emerald-600');
            }, 2000);
        }
    </script>
</body>
</html>